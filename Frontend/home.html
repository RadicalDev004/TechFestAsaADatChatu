<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home</title>
  <style>
    :root {
      --bg: #fff7f5;                /* very light warm background */
      --card: #ffffff;              /* card surface */
      --text: #2a2a2a;              /* primary text */
      --muted: #6b7280;             /* secondary text */
      --primary: #ff6b6b;           /* light red */
      --primary-700: #e25555;       /* darker red */
      --accent: #ff8a3d;            /* orange */
      --accent-700: #e4762e;        /* darker orange */
      --ring: rgba(255, 107, 107, 0.35);
      --shadow: 0 10px 30px rgba(255, 107, 107, 0.15), 0 4px 12px rgba(0,0,0,0.05);
      --radius-lg: 16px;
      --radius-xl: 22px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 800px at 90% -10%, rgba(255,138,61,0.12), transparent 60%),
                  radial-gradient(1200px 800px at -10% 10%, rgba(255,107,107,0.12), transparent 60%),
                  var(--bg);
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px clamp(16px, 4vw, 40px) 120px; /* bottom padding so FAB doesn't cover content */
    }

    /* Header */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(8px);
      background: linear-gradient(to bottom, rgba(255,255,255,0.85), rgba(255,255,255,0.6));
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .topbar-inner {
      display: flex;
      align-items: center;
      gap: 16px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px clamp(16px, 4vw, 40px);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 800;
      letter-spacing: 0.3px;
    }
    .brand-mark {
      width: 36px; height: 36px; border-radius: 12px;
      background: conic-gradient(from 210deg, var(--primary), var(--accent));
      box-shadow: 0 8px 24px rgba(255,138,61,0.35);
    }
    .brand-name { font-size: 1.1rem; }

    .spacer { flex: 1; }

    .link {
      color: var(--accent-700);
      font-weight: 600;
      text-decoration: none;
      padding: 10px 14px;
      border-radius: 12px;
      transition: background 160ms ease, transform 120ms ease;
    }
    .link:hover { background: rgba(255,138,61,0.12); }

    /* Title + actions */
    .header {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: end;
      margin: 24px 0 14px;
    }
    .title {
      font-size: clamp(1.2rem, 1rem + 1.6vw, 2.2rem);
      font-weight: 800;
      line-height: 1.1;
      letter-spacing: -0.5px;
    }
    .subtitle { color: var(--muted); margin-top: 8px; }

    .actions { display: flex; gap: 10px; }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      border: none;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease, background 160ms ease;
      box-shadow: var(--shadow);
    }
    .btn:active { transform: translateY(1px) scale(0.995); }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
    }
    .btn-primary:hover { filter: brightness(1.05); }

    .btn-outline {
      background: #fff;
      color: var(--accent-700);
      border: 2px solid rgba(255,138,61,0.25);
    }
    .btn-outline:hover { background: rgba(255,138,61,0.07); }

    /* Grid */
    .docs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 10px;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: grid;
      grid-template-rows: 140px auto;
      transition: transform 150ms ease, box-shadow 150ms ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 14px 36px rgba(255, 107, 107, 0.25), 0 6px 18px rgba(0,0,0,0.08); }
    .thumb {
      background: linear-gradient(135deg, rgba(255,107,107,0.2), rgba(255,138,61,0.2));
      display: grid; place-items: center;
    }
    .thumb > .doc-icon {
      width: 46px; height: 58px; border-radius: 6px;
      background: linear-gradient(180deg, #fff, #ffe2da);
      border: 2px solid rgba(255,107,107,0.35);
      position: relative;
      box-shadow: 0 6px 14px rgba(255, 107, 107, 0.25);
    }
    .doc-icon::after {
      content: ""; position: absolute; right: -6px; top: -6px;
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 4px 10px rgba(255,138,61,0.45);
    }
    .card-body { padding: 14px; }
    .doc-title { font-weight: 800; line-height: 1.2; }
    .doc-meta { color: var(--muted); font-size: 0.9rem; margin-top: 6px; }

    /* Empty state */
    .empty {
      margin: 32px 0; padding: 18px; border-radius: var(--radius-lg);
      border: 2px dashed rgba(255,107,107,0.3);
      background: rgba(255,107,107,0.06);
      color: var(--muted);
      text-align: center;
    }

    /* Hidden file input */
    input[type="file"] { display: none; }

    /* Floating Action Button (AI Chat) */
    .fab {
      position: fixed;
      right: 22px; bottom: 22px;
      width: 64px; height: 64px;
      border-radius: 50%;
      border: none; cursor: pointer;
      color: white; font-size: 22px; font-weight: 800;
      background: radial-gradient(circle at 30% 30%, var(--accent), var(--primary));
      box-shadow: 0 18px 38px rgba(255,107,107,0.45), 0 6px 16px rgba(0,0,0,0.12);
      display: grid; place-items: center;
      transition: transform 160ms ease, box-shadow 160ms ease, filter 160ms ease;
      z-index: 50;
    }
    .fab:hover { transform: translateY(-2px) scale(1.03); filter: saturate(1.1); }

    /* Chat Panel (local div) */
    .chat-panel {
      position: fixed; right: 16px; bottom: 96px;
      width: min(720px, calc(100vw - 32px));
      max-height: min(70vh, 660px);
      display: grid;
      grid-template-rows: auto 1fr auto;
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 22px 60px rgba(255,107,107,0.35), 0 10px 26px rgba(0,0,0,0.15);
      border: 1px solid rgba(255,107,107,0.20);
      transform: translateY(20px) scale(0.98);
      opacity: 0; pointer-events: none;
      transition: transform 200ms ease, opacity 200ms ease;
      overflow: hidden;
      z-index: 49;
    }
    .chat-panel.active {
      opacity: 1; pointer-events: auto;
      transform: translateY(0) scale(1);
      outline: 2px solid var(--ring);
    }
    .chat-head {
      padding: 14px 16px;
      background: linear-gradient(135deg, rgba(255,107,107,0.10), rgba(255,138,61,0.10));
      display: flex; align-items: center; gap: 12px;
      border-bottom: 1px solid rgba(255,107,107,0.2);
    }
    .status-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(255,138,61,0.18);
    }
    .chat-title { font-weight: 800; }
    .chat-body {
      padding: 14px; overflow: auto; background: linear-gradient(180deg, rgba(255,107,107,0.03), transparent);
    }
    .msg { display: grid; gap: 6px; margin: 10px 0; }
    .bubble {
      width: fit-content;
      max-width: 75%; padding: 10px 12px; border-radius: 14px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
    }
    .bubble.ai { background: #fff0ec; border: 1px solid rgba(255,107,107,0.25); }
    .bubble.me { margin-left: auto; background: #fff7f0; border: 1px solid rgba(255,138,61,0.25); }
    .chat-input {
      display: flex; gap: 10px; padding: 12px; border-top: 1px solid rgba(255,107,107,0.2);
      background: #fff;
    }
    .chat-input input {
      flex: 1; padding: 12px 14px; border-radius: 12px; border: 2px solid rgba(255,107,107,0.25);
      outline: none; font-size: 1rem;
    }
    .chat-input input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(255,138,61,0.12); }
    .send-btn {
      padding: 12px 16px; border-radius: 12px; border: none; cursor: pointer; font-weight: 800; color: #fff;
      background: linear-gradient(135deg, var(--accent), var(--primary));
      box-shadow: 0 10px 24px rgba(255,138,61,0.35);
    }

    /* Utility */
    
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
    /* Fullscreen overlay additions */
.chat-panel.fullscreen {
  inset: 0; width: 100vw; height: 100vh; max-height: none;
  border-radius: 0; box-shadow: none; border: none;
  background: linear-gradient(135deg, rgba(255,107,107,0.08), rgba(255,138,61,0.08)), var(--card);
  z-index: 60;
}
.chat-head .spacer { flex: 1; }
.fs-btn {
  border: none; cursor: pointer; font-weight: 800; color: #fff;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  padding: 10px 12px; border-radius: 12px;
  box-shadow: 0 10px 24px rgba(255,138,61,0.35);
}

/* Chat layout: sidebar + main */
.chat-layout { display: grid; grid-template-columns: 1fr; min-height: 0; }
.chat-panel.fullscreen .chat-layout { grid-template-columns: 300px 1fr; }

/* Sidebar (hidden when not fullscreen) */
.sidebar { display: none; border-right: 1px solid rgba(255,107,107,0.2); background: #fff; overflow: auto; }
.chat-panel.fullscreen .sidebar { display: flex; flex-direction: column; align-items: flex-start; padding: 8px; gap: 6px; }
.sidebar-head { padding: 12px; border-bottom: 1px solid rgba(255,107,107,0.2); background: #fff7f5; width: 100%; }
.new-chat-btn {
  width: 100%; border: none; cursor: pointer; font-weight: 800; color: #fff;
  border-radius: 10px; padding: 10px 12px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
}
.conv-list { width: 100%; list-style: none; margin: 0; padding: 8px; display: grid; gap: 8px; }
.conv-btn {
  width: 100%; text-align: left; border: 2px solid transparent; padding: 10px 12px;
  border-radius: 12px; background: #e1e1e1; cursor: pointer; font-weight: 700; color: var(--text);
  transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease, background 120ms ease;
}
.conv-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.06); }
.conv-btn.active {
  background: linear-gradient(135deg, rgba(255,107,107,0.18), rgba(255,138,61,0.18));
  border-color: rgba(255,107,107,0.5);
  box-shadow: 0 10px 22px rgba(255,107,107,0.25);
}

/* Main chat area tweaks for grid */
.chat-main { display: grid; grid-template-rows: 1fr auto; min-height: 0; }

  .card {
  position: relative;
}
.card-actions {
  position: absolute;
  top: 6px;
  left: 6px;
  right: 6px;
  display: flex;
  justify-content: space-between;
  pointer-events: none; /* allow clicks only on buttons */
}
.card-actions button {
  pointer-events: all;
  border: none;
  background: rgba(255,255,255,0.9);
  color: var(--text);
  font-size: 14px;
  border-radius: 8px;
  padding: 4px 8px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transition: background 0.2s;
}
.card-actions button:hover {
  background: var(--accent);
  color: white;
}
  :root {
    --upload-bg: rgba(0,0,0,0.35);
    --upload-card: #ffffff;
    --upload-text: #2a2a2a;
    --upload-muted: #6b7280;
    --upload-accent: #ff6b6b;
    --upload-shadow: 0 16px 40px rgba(0,0,0,0.18);
    --upload-radius: 18px;
  }

  .uploading-overlay {
    position: fixed;
    inset: 0;
    display: none;                /* hidden by default */
    place-items: center;
    background: var(--upload-bg);
    z-index: 9999;                /* above everything */
    backdrop-filter: blur(1px);
  }
  .uploading-overlay.active { display: grid; }

  .uploading-card {
    width: min(360px, 92vw);
    background: var(--upload-card);
    color: var(--upload-text);
    border-radius: var(--upload-radius);
    box-shadow: var(--upload-shadow);
    padding: 28px 22px 18px;
    display: grid;
    grid-template-rows: auto auto;
    gap: 16px;
    text-align: center;
    transform: translateY(8px) scale(0.98);
    opacity: 0;
    transition: transform 160ms ease, opacity 160ms ease;
  }
  .uploading-overlay.active .uploading-card {
    transform: translateY(0) scale(1);
    opacity: 1;
  }

  /* Spinner */
  .uploading-spinner {
    width: 68px; height: 68px;
    margin: 0 auto;
    border-radius: 50%;
    border: 6px solid #eee;
    border-top-color: var(--upload-accent);
    animation: spin 900ms linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .uploading-text {
    font-weight: 800;
    font-size: 1.05rem;
    letter-spacing: .2px;
  }
  .uploading-sub {
    margin-top: 4px;
    color: var(--upload-muted);
    font-size: .95rem;
    word-break: break-word;
  }

  /* === Image Message (AI) === */
.img-msg {
  position: relative;
  display: inline-block;
  border-radius: 14px;
  overflow: hidden;
  background: #fff;
  border: 1px solid rgba(255,107,107,0.25);
  box-shadow: 0 10px 24px rgba(0,0,0,0.08);
}
.img-msg img {
  display: block;
  max-width: min(420px, 70vw);
  height: auto;
  object-fit: cover;
}
.img-msg .img-bar {
  position: absolute; inset: auto 8px 8px 8px;
  display: flex; gap: 8px; justify-content: space-between; align-items: center;
  background: rgba(255,255,255,0.92);
  border: 1px solid rgba(255,107,107,0.25);
  border-radius: 10px;
  padding: 6px 8px;
  backdrop-filter: blur(4px);
}
.img-msg .img-meta {
  font-size: .9rem; color: var(--muted); font-weight: 600;
}
.img-msg .img-actions { display: flex; gap: 6px; }
.img-msg .img-actions button {
  border: none; cursor: pointer; padding: 6px 8px; border-radius: 8px;
  background: #fff; color: var(--text); font-weight: 700;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  transition: background 120ms ease, transform 120ms ease;
}
.img-msg .img-actions button:hover {
  background: rgba(255,138,61,0.12);
  transform: translateY(-1px);
}
/* Optional caption under image */
.img-caption {
  margin-top: 8px;
  color: var(--muted);
  font-size: .95rem;
}

/* === Voice Message (AI) === */
.voice-msg {
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border-radius: 12px;
  background: #fff;                         /* nests inside your .bubble.ai */
  border: 1px solid rgba(255,107,107,0.25);
  box-shadow: 0 6px 14px rgba(0,0,0,0.05) inset;
}
/* Play button */
.voice-btn {
  width: 44px; height: 44px; border-radius: 999px;
  border: none; cursor: pointer; color: #fff; font-weight: 800;
  background: linear-gradient(135deg, var(--accent), var(--primary));
  box-shadow: 0 10px 22px rgba(255,138,61,0.35);
  display: grid; place-items: center;
  transition: transform 120ms ease, filter 120ms ease;
}
.voice-btn:hover { transform: translateY(-1px) scale(1.02); filter: saturate(1.05); }

/* Timeline + times */
.voice-track { display: grid; gap: 8px; min-width: 180px; }
.voice-time {
  display: flex; gap: 10px; align-items: center; justify-content: space-between;
  font-size: .9rem; color: var(--muted); font-weight: 700;
}

/* Progress bar */
.voice-progress {
  position: relative; height: 6px; border-radius: 999px; overflow: hidden;
  background: rgba(255,138,61,0.18);
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
}
.voice-progress .bar {
  position: absolute; inset: 0 auto 0 0;
  width: 0%;                                  /* set dynamically */
  background: linear-gradient(90deg, var(--accent), var(--primary));
  box-shadow: 0 3px 12px rgba(255,107,107,0.35);
}

/* “Fake” waveform (optional) */
.voice-wave {
  display: grid; grid-auto-flow: column; grid-auto-columns: 3px;
  align-items: end; gap: 2px; height: 26px; overflow: hidden;
}
.voice-wave span {
  display: block; width: 3px; border-radius: 2px;
  background: linear-gradient(180deg, var(--primary), var(--accent));
  opacity: .9;
  animation: wobble 1000ms ease-in-out infinite;
}
.voice-wave span:nth-child(odd) { animation-duration: 1200ms; opacity: .8; }
.voice-wave span:nth-child(3n) { animation-duration: 900ms; opacity: .7; }
@keyframes wobble {
  0%,100% { height: 20%; }
  50% { height: 100%; }
}

/* Right-side metadata */
.voice-meta { display: grid; gap: 6px; align-items: center; justify-items: end; }
.voice-chip {
  background: rgba(255,107,107,0.10);
  border: 1px solid rgba(255,107,107,0.25);
  color: var(--accent-700);
  font-weight: 800; font-size: .85rem;
  padding: 6px 10px; border-radius: 999px;
}
.voice-action {
  border: none; cursor: pointer; padding: 6px 10px; border-radius: 8px;
  background: #fff; color: var(--text); font-weight: 700;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.voice-action:hover { background: rgba(255,138,61,0.12); }

/* Responsive tweaks */
@media (max-width: 520px) {
  .voice-msg { grid-template-columns: auto 1fr; }
  .voice-meta { grid-column: 1 / -1; justify-items: start; }
}
/* The X itself */
.conv-btn .conv-x {
  position: absolute;
  right: 12px;           /* use inset-inline-end for RTL if you prefer */
  top: 50%;
  transform: translateY(-50%);
  display: inline-grid;
  place-items: center;
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 8px;
  background: rgba(255,255,255,0.9);
  color: var(--muted);
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transition: background .2s, color .2s, transform .1s;
}

.conv-btn .conv-x:hover {
  background: var(--accent);
  color: #fff;
  transform: translateY(-50%) translateY(-1px);
}

.conv-btn .conv-x:active {
  transform: translateY(-50%) translateY(0);
}

.conv-btn:has(.conv-x) {
  position: relative;
  padding-right: 42px; /* room so text doesn't sit under the X */
}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-mark" aria-hidden="true"></div>
        <div class="brand-name">{{clinic_name}}</div>
      </div>
      <div class="spacer"></div>
      <a class="link" href="/auth/index">Logout</a>
    </div>
  </div>

  <main class="wrap">
    <div class="header">
      <div>
        <div class="title">Your Documents</div>
        <div class="subtitle">Keep everything neat and searchable. Add a new document or open an existing one.</div>
      </div>
      <div class="actions">
        <!-- <button class="btn btn-outline" id="importBtn" type="button">Import</button> -->
        <button class="btn btn-primary" id="addDocBtn" type="button">+ Add Document</button>
        <input type="file" id="fileInput" accept="*/*" />
      </div>
    </div>

    <div id="emptyState" class="empty" role="status" aria-live="polite" style="display:none;">
      No documents yet. Click <strong>Add Document</strong> to get started.
    </div>

    <section class="docs-grid" id="docsGrid" aria-label="Documents Grid">
      <!-- Cards will be injected here -->
    </section>
  </main>

  <!-- Floating AI Chat Button -->
  <button class="fab" id="fab" aria-label="Open AI Assistant">✦</button>

  <!-- AI Chat Panel (local div) -->
<section class="chat-panel" id="chatPanel" aria-labelledby="chatTitle" aria-hidden="true" role="dialog">
  <header class="chat-head">
    <span class="status-dot" aria-hidden="true"></span>
    <div id="chatTitle" class="chat-title">AI Visualisation Assistant</div>
    <div class="spacer"></div>
    <button class="fs-btn" id="fsBtn" type="button" aria-pressed="false" aria-label="Toggle fullscreen">⤢ Fullscreen</button>
  </header>

  <div class="chat-layout">
    <aside class="sidebar" id="chatSidebar" aria-label="Conversation list">
      <div class="sidebar-head">
        <button class="new-chat-btn" id="newChatBtn" type="button">+ New Chat</button>
      </div>
      <ul class="conv-list" id="convList"></ul>
    </aside>

    <div class="chat-main">
      <div class="chat-body" id="chatBody"></div>
      <form class="chat-input" id="chatForm">
        <label class="sr-only" for="chatText">Message</label>
        <input id="chatText" autocomplete="off" placeholder="Type a message…" />
        <button class="send-btn" type="submit">Send</button>
      </form>
    </div>
  </div>
</section>

  <script>
    // --- Document Grid Logic ---
    const docs = [];
    const docsGrid = document.getElementById('docsGrid');
    const emptyState = document.getElementById('emptyState');

    function renderDocs() {
      docsGrid.innerHTML = '';
      console.log("Rendering docs:", docs);
  if (docs.length === 0) {
    emptyState.style.display = 'block';
    return;
  }
  emptyState.style.display = 'none';

  for (const [index, d] of docs.entries()) {
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-actions">
        <button class="download-btn" title="Download">⬇</button>
        <button class="delete-btn" title="Delete">✕</button>
      </div>
      <div class="thumb"><div class="doc-icon" aria-hidden="true"></div></div>
      <div class="card-body">
        <div class="doc-title">${d.title}</div>
        <div class="doc-meta">${d.size} • ${d.date}</div>
      </div>
    `;

    card.querySelector('.download-btn').addEventListener('click', async (e) => {
      e.stopPropagation();
      try {
    const res = await fetch(`/api/download/${encodeURIComponent(d.title)}`, {
      method: 'GET',
      headers: {
        Authorization: `Bearer ${getTokenFromCookie()}`
      }
    });
    if (!res.ok) throw new Error('Download failed');

    const { message: signedUrl } = await res.json(); // <-- parse JSON
    // Open the signed URL (lets Firebase/Cloud Storage serve the bytes)
    // Same-tab:
    window.location.assign(signedUrl);
    // Or new tab:
    // window.open(signedUrl, '_blank', 'noopener,noreferrer');
  } catch (err) {
    console.warn(err);
    alert('Download failed.');
  }
    });

    // Delete handler
    card.querySelector('.delete-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      if (confirm(`Delete document "${d.title}"?`)) {
        triggerLoad(d.title, "Deleting");
        fetch(`/api/delete/${encodeURIComponent(d.title)}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            "Authorization": `Bearer ${getTokenFromCookie()}`
          },
          body: JSON.stringify({ title: d.title })
        }).then(res => {
          if (!res.ok) throw new Error('Delete failed');
        }).then(result => {
          console.log('Deleted:', result);
          docs.splice(index, 1);
          renderDocs();
        }).catch(err => {
          console.warn(err);
          alert('Delete failed.');

        }).finally(() => {
          endLoad();
        })
      }
    });

    card.addEventListener('click', () => {
      alert('Open document: ' + d.title);
    });

    docsGrid.appendChild(card);
  }
}

    function fileSizeString(bytes) {
      const units = ['B','KB','MB','GB'];
      let i = 0; let n = bytes;
      while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
      return `${n.toFixed(n < 10 && i > 0 ? 1 : 0)} ${units[i]}`;
    }

    // --- Add / Import ---
    const addDocBtn = document.getElementById('addDocBtn');
    //const importBtn = document.getElementById('importBtn');
    const fileInput = document.getElementById('fileInput');

    addDocBtn.addEventListener('click', () => fileInput.click());
    //importBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      // Optimistically add to grid
      const now = new Date();
      const doc = {
        title: file.name,
        size: fileSizeString(file.size || 0),
        date: now.toLocaleDateString("en-GB", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric"
        }) + " " + now.toLocaleTimeString("en-GB", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false   // 24-hour format
        })
      };
      
      
      triggerLoad(file.name, "Uploading");
      // Upload to your backend if available
      try {
        const formData = new FormData();
        formData.append('file', file);
        const res = await fetch('/api/upload', 
        { 
          method: 'POST', 
          headers: {
            "Authorization": `Bearer ${getTokenFromCookie()}`
          },
          body: formData 
        });
        if (!res.ok) throw new Error('Upload failed');
        const result = await res.json().catch(() => ({}));
        console.log('Uploaded:', result);
        docs.unshift(doc);
        renderDocs();
      } catch (err) {
        console.warn(err);
        alert('Upload failed. The document was added locally, but not uploaded.');
      } finally {
        fileInput.value = '';
        endLoad();
      }
    });

    // Initial render
    renderDocs();

    // --- AI Chat (local div activation) ---
const fab = document.getElementById('fab');
const chatPanel = document.getElementById('chatPanel');
const chatBody = document.getElementById('chatBody');
const chatForm = document.getElementById('chatForm');
const chatText = document.getElementById('chatText');
const fsBtn = document.getElementById('fsBtn');
const convList = document.getElementById('convList');
const newChatBtn = document.getElementById('newChatBtn');

function setChatActive(active) {
  chatPanel.classList.toggle('active', active);
  chatPanel.setAttribute('aria-hidden', String(!active));
  if (active) chatText.focus();
}

function setFullscreen(on) {
  chatPanel.classList.toggle('fullscreen', on);
  fsBtn.setAttribute('aria-pressed', String(on));
  fsBtn.textContent = on ? '⤢ Exit Fullscreen' : '⤢ Fullscreen';
}

fab.addEventListener('click', () => {
  const isActive = chatPanel.classList.contains('active');
  setChatActive(!isActive);
});
fsBtn.addEventListener('click', () => setFullscreen(!chatPanel.classList.contains('fullscreen')));

let conversations = [
  //{ id: cryptoRandomId(), title: 'Welcome', messages: [ { who: 'ai', text: 'Hi! I’m your local assistant. Ask me to find or summarize a document.' } ] }
];
let currentIndex = 0;
let maxIndex = 0;

function cryptoRandomId(){ return Math.random().toString(36).slice(2,10); }

function renderConversations(){
  console.log("Rendering conversations:", conversations);
  convList.innerHTML = '';
  conversations.forEach((c, idx) => {
    const li = document.createElement('li');
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'conv-btn' + (idx === currentIndex ? ' active' : '');
    btn.textContent = c.title;
    btn.addEventListener('click', () => { currentIndex = idx; renderMessages(c.id); renderConversations(); });

    const xBtn = document.createElement('button');
    xBtn.type = 'button';
    xBtn.className = 'conv-x';
    xBtn.textContent = '✕';
    xBtn.title = `Delete "${c.title}"`;
    xBtn.setAttribute('aria-label', `Delete "${c.title}"`);
    xBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      deleteConversation(c.id);
    });
    btn.appendChild(xBtn);
    li.appendChild(btn);
    convList.appendChild(li);
    if(idx > maxIndex) maxIndex = idx;
  });
}

function renderMessages(id){
  chatBody.innerHTML = '';
  if(id == null) return;

  fetch(`/api/conversations/${id}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            "Authorization": `Bearer ${getTokenFromCookie()}`
          }
        }).then(res => {
          if (!res.ok) throw new Error('Fetch failed');
          return res.json();
        }).then(result => {
            const msgs = result.messages || [];
            for (const m of msgs){ 

              let fullMsg = m.content;

              let Imatch = fullMsg.match(/<img\b[^>]*>([\s\S]*?)<\/img>/i);
              let base64Img = Imatch ? Imatch[1].trim() : null;
              if (Imatch) {
                fullMsg = fullMsg.replace(Imatch[0], '').trim();
                createImageMessage(base64Img);
              }

              let Amatch = fullMsg.match(/<audio\b[^>]*>([\s\S]*?)<\/audio>/i);
              let base64Audio = Amatch ? Amatch[1].trim() : null;

              if (Amatch) {
                fullMsg = fullMsg.replace(Amatch[0], '').trim();
              }

              pushMsg(m.role == "user" ? "me" : "ai", fullMsg); 

              if(Amatch) {
                createVoiceMessage(base64Audio);
              }
            }
        }).catch(err => {
          console.warn(err);

        }).finally(() => {

        })

  //const msgs = conversations[currentIndex].messages;
  //for (const m of msgs){ appendMsg(m.who, m.text, false); }

  chatBody.scrollTop = chatBody.scrollHeight;
}

newChatBtn.addEventListener('click', () => {
  const name = prompt("Enter a name for the new chat:", `Chat ${conversations.length + 1}`);
  if (!name) return;

  addConversation(name);
});

// Local echo demo
chatForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const text = chatText.value.trim();
  if (!text) return;
  if(conversations.length === 0) {
    alert('Please create a new chat first.');
    return;
  }
  pushMsg('me', text);
  pushMsg('ai', "Thinking...");
  fetch('/api/conversations/' + conversations[currentIndex].id + '/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            "Authorization": `Bearer ${getTokenFromCookie()}`
          },
          body: JSON.stringify({ content: text })
        }).then(res => {
          if (!res.ok) throw new Error('Send failed');
          return res.json();
        }).then(result => {
            console.log('Message sent:', result);
            let fullMsg = result.content;

            let Imatch = fullMsg.match(/<img\b[^>]*>([\s\S]*?)<\/img>/i);
            let base64Img = Imatch ? Imatch[1].trim() : null;
            if (Imatch) {
              fullMsg = fullMsg.replace(Imatch[0], '').trim();
              createImageMessage(base64Img);
            }

            let Amatch = fullMsg.match(/<audio\b[^>]*>([\s\S]*?)<\/audio>/i);
            let base64Audio = Amatch ? Amatch[1].trim() : null;

            if (Amatch) {
              fullMsg = fullMsg.replace(Amatch[0], '').trim();
            }

            chatBody.removeChild(chatBody.lastChild);
            pushMsg('ai', fullMsg);

            if(Amatch) {
              createVoiceMessage(base64Audio);
            }
            console.log(result);
        }).catch(err => {
          console.warn(err);
          alert('Send failed.');

        }).finally(() => {

        })
  chatText.value = '';
  
});

function pushMsg(who, text){
  //conversations[currentIndex].messages.push({ who, text });
  appendMsg(who, text, true);
}

function appendMsg(who, text, scroll){
  const msg = document.createElement('div');
  msg.className = 'msg';
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (who === 'ai' ? 'ai' : 'me');
  bubble.textContent = text;
  msg.appendChild(bubble);
  chatBody.appendChild(msg);
  if (scroll) chatBody.scrollTop = chatBody.scrollHeight;
}

function generateLocalReply(q) {
  const lower = q.toLowerCase();
  if (lower.includes('find') || lower.includes('search')) {
    if (docs.length === 0) return 'You have no documents yet. Try “Add Document”.';
    const top = docs[0];
    return `I can help search once connected to the server. Meanwhile, your most recent document is “${top.title}”.`;
  }
  if (lower.includes('hello') || lower.includes('hi')) return 'Hello! What would you like to do with your library today?';
  if (lower.includes('upload')) return 'Click “Add Document” to choose a file. It uploads to /api/upload.';
  return 'Got it. (This is a local demo assistant. Connect me to your backend for real AI.)';
}

function getTokenFromCookie() {
  const tokenCookie = document.cookie
    .split("; ")
    .find(row => row.startsWith("access_token="));
  return tokenCookie ? tokenCookie.split("=")[1] : null;
}

async function fetchFiles() {
  console.log("Fetching files from backend...");
  const token = getTokenFromCookie();
  if (!token) {
    console.error("No access_token found in cookies!");
    return [];
  }

  try {
    const response = await fetch("/api/listFiles", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`,
      },
    });

    if (!response.ok) {
      const errText = await response.text();
      throw new Error(`HTTP error! ${response.status} - ${errText}`);
    }

    const data = await response.json();
    console.log("Fetched files:", data);
    const gotDocs = data.files.map(f => ({
    id: f.path,     
    title: f.name,   
    size: f.size,     
    date: f.updated     
  }));
  if(gotDocs.length != 0) {
    emptyState.style.display = 'none';
  }
  for (const [index, d] of gotDocs.entries()) {
    const doc = {
        title: d.title,
        size: d.size,
        date: d.date
      };
      docs.unshift(doc);
  }
  renderDocs();
    return data.files;
  } catch (error) {
    console.error("Error fetching files:", error);
    return [];
  }
}

  function triggerLoad(filename, info = '') {
    const overlay = document.getElementById('uploadingOverlay');
    const titleEl = document.getElementById('uploadingTitle');
    const infoEl = document.getElementById('uploadingDesc');

    titleEl.textContent = info + '...';
    infoEl.textContent = info + ' ' + filename;
    overlay.classList.add('active');
  }

  function endLoad() {
    const overlay = document.getElementById('uploadingOverlay');
    overlay.classList.remove('active');
  }

  function getConversations() {
    fetch('/api/conversations', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            "Authorization": `Bearer ${getTokenFromCookie()}`
          }
        }).then(res => {
          if (!res.ok) throw new Error('Delete failed');
          return res.json();
        }).then(result => {
            
            conversations = result || [];
            if (conversations.length === 0) {
              //conversations.push({ id: cryptoRandomId(), title: 'Welcome', messages: [ { who: 'ai', text: 'Hi! I’m your local assistant. Ask me to find or summarize a document.' } ] });
            }
            console.log('Conversations:', conversations);
            currentIndex = 0;
            renderConversations();
        }).catch(err => {
          console.warn(err);

        }).finally(() => {
          renderMessages(conversations.length > 0 ? conversations[0].id : null);
        })        
  }

  function addConversation(convTitle) {
      fetch('/api/conversations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            "Authorization": `Bearer ${getTokenFromCookie()}`
          },
          body: JSON.stringify({ title: convTitle })
        }).then(res => {
          if (!res.ok) throw new Error('Delete failed');
          return res.json();
        }).then(result => {
            console.log('Conversations:', result);
            conversations.unshift({
            id: result.id,
            title: result.title,
            messages: [
            ]
          });
        }).catch(err => {
          console.warn(err);

        }).finally(() => {
          currentIndex = 0;
          renderConversations();
          renderMessages();
        })  
  }

  // Utility: wrapper
function makeMsgWrapper() {
  const msg = document.createElement('div');
  msg.className = 'msg';
  const bubble = document.createElement('div');
  bubble.className = 'bubble ai';
  msg.appendChild(bubble);
  return { msg, bubble };
}

// === Create AI Image Message ===
function createImageMessage(base64) {
  const { msg, bubble } = makeMsgWrapper();

  const imgMsg = document.createElement('div');
  imgMsg.className = 'img-msg';
  imgMsg.innerHTML = `
    <img src="${base64}" alt="AI generated image" />
  `;

  bubble.appendChild(imgMsg);
  document.getElementById('chatBody').appendChild(msg);
  chatBody.scrollTop = chatBody.scrollHeight;
}

// === Create AI Voice Message ===
function createVoiceMessage(base64) {
  const { msg, bubble } = makeMsgWrapper();

  const voiceMsg = document.createElement('div');
  voiceMsg.className = 'voice-msg';

  // Hidden audio
  const audio = document.createElement('audio');
  audio.src = `${base64}`;
  audio.preload = 'auto';

  // Play button
  const playBtn = document.createElement('button');
  playBtn.className = 'voice-btn';
  playBtn.textContent = '▶';

  playBtn.addEventListener('click', () => {
    if (audio.paused) {
      audio.play();
      playBtn.textContent = '⏸';
    } else {
      audio.pause();
      playBtn.textContent = '▶';
    }
  });

  // Progress bar
  const voiceTrack = document.createElement('div');
  voiceTrack.className = 'voice-track';
  voiceTrack.innerHTML = `
    <div class="voice-progress"><div class="bar"></div></div>
  `;

  const bar = voiceTrack.querySelector('.bar');
  audio.addEventListener('timeupdate', () => {
    if (audio.duration) {
      bar.style.width = `${(audio.currentTime / audio.duration) * 100}%`;
    }
  });
  audio.addEventListener('ended', () => { playBtn.textContent = '▶'; });

  // Meta
  // const meta = document.createElement('div');
  // meta.className = 'voice-meta';
  // meta.innerHTML = `<button class="voice-action" type="button">Download</button>`;
  // meta.querySelector('.voice-action').addEventListener('click', () => {
  //   const link = document.createElement('a');
  //   link.href = audio.src;
  //   link.download = 'voice-message.wav';
  //   link.click();
  // });

  // Build structure
  voiceMsg.appendChild(playBtn);
  voiceMsg.appendChild(voiceTrack);
  //voiceMsg.appendChild(meta);
  bubble.appendChild(voiceMsg);
  bubble.appendChild(audio);

  document.getElementById('chatBody').appendChild(msg);
  chatBody.scrollTop = chatBody.scrollHeight;
}

async function deleteConversation(id, { confirmFirst = true } = {}) {
  const idx = conversations.findIndex(c => c.id === id);
  if (idx === -1) return;

  const title = conversations[idx].title || 'this chat';
  if (confirmFirst && !confirm(`Delete conversation "${title}"?`)) return;

  try {
    triggerLoad(title, 'Deleting conversation');
    const res = await fetch(`/api/conversations/${encodeURIComponent(id)}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getTokenFromCookie()}`
      }
    });
    if (!res.ok) throw new Error('Delete failed');

    const deletingCurrent = conversations[currentIndex]?.id === id;
    conversations.splice(idx, 1);

    if (conversations.length === 0) {
      currentIndex = 0;
      renderConversations();
      renderMessages(null);
      return;
    }

    if (deletingCurrent) {
      currentIndex = Math.min(idx, conversations.length - 1);
      renderConversations();
      renderMessages(conversations[currentIndex].id);
    } else {
      if (idx < currentIndex) currentIndex = Math.max(0, currentIndex - 1);
      renderConversations();
    }
  } catch (err) {
    console.warn(err);
    alert('Delete failed.');
  } finally {
    endLoad();
  }
}

// Initial render
fetchFiles().then(files => {
  files.forEach(file => console.log(file));
});

getConversations();
  </script>

  <div class="uploading-overlay" id="uploadingOverlay" role="dialog" aria-modal="true" aria-labelledby="uploadingTitle" aria-describedby="uploadingDesc">
  <div class="uploading-card" role="status" aria-live="polite">
    <div class="uploading-spinner" aria-hidden="true"></div>
    <div>
      <div id="uploadingTitle" class="uploading-text">Uploading…</div>
      <div id="uploadingDesc" class="uploading-sub">uploading</div>
    </div>
  </div>
</div>
</body>
</html>
